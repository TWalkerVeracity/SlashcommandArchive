javascript: !async function(){function e(e,n){const t=document.getElementById("eus-progress");t&&(t.textContent=`${e} / ${n} completed`)}function n(e,n){const t=document.getElementById(`eus-item-${e}`);if(!t)return;const s=t.querySelector(".eus-status");s.innerHTML={pending:'<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2"/><path d="M12 6v6l4 2" stroke-width="2" stroke-linecap="round"/></svg>',processing:'<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" fill="currentColor"/></svg>',completed:'<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',error:'<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>'}[n],s.className=`eus-status eus-${n}`}function t(){const e=document.getElementById("eus-modal");e&&(e.remove(),window.eusKeyHandler&&(document.removeEventListener("keydown",window.eusKeyHandler),window.eusKeyHandler=null))}function s(){if(window.g_ck)return window.g_ck;throw new Error("Failed to get auth token")}async function o(e,n={}){const t=s();return fetch(e,{...n,headers:{"X-UserToken":t,...n.headers}})}function r(e){return e.base_update_set&&e.base_update_set.value}function a(e){return e.base_update_set?.value===e.sys_id}function i(e){return e.replaceAll(" ","")}async function c(e,n){return async function(e){const n=s(),t=new URLSearchParams({script:`gs.info("~~~" + JSON.stringify(${e}) + "~~~");`,sys_scope:"global",runscript:"true",sysparm_ck:n,quota_managed_transaction:"on"}),o=await fetch("/sys.scripts.do",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t}),r=await o.text(),a=document.createElement("textarea");a.innerHTML=r;const i=a.value,c=/~~~(.*)~~~/.exec(i);if(!c)throw new Error("Failed to parse background script response");return JSON.parse(c[1])}(`(function() {\n  try {\n    var updateSetGr = new GlideRecord("sys_update_set");\n    if (!updateSetGr.get("${e}"))\n      return { success: false, error: "Update set not found." };\n    \n    var updateSetExport = new UpdateSetExport();\n    var stagedUpdateSet = updateSetExport.${n?"exportHierarchy":"exportUpdateSet"}(updateSetGr);\n    \n    return { success: true, staged_set: stagedUpdateSet };\n  } catch (e) {\n    return { success: false, error: e.message };\n  }\n})()`)}async function d(e,n,t){try{console.log(`[${n}/${t}] Staging update set ${e}...`);const r=await async function(e){const n=await o(`/api/now/table/sys_update_set/${e}?sysparm_fields=sys_id,name,base_update_set,application&sysparm_display_value=all`);return(await n.json()).result}(e);if(!r)throw new Error("Update set not found");const d=a(r),l=r.name?.display_value||r.name?.value||"update_set";let u="";r.application&&("string"==typeof r.application?u=r.application:r.application.display_value?u=r.application.display_value:r.application.value&&(u=String(r.application.value)));const p=await c(e,d);if(!p.success||!p.staged_set)throw new Error(p.error||"Failed to stage update set");return console.log(`[${n}/${t}] Downloading ${l}...`),await async function(e,n,t,r){const a=`/${n?"export_base_update_set.do":"export_update_set.do"}?sysparm_sys_id=${e}&sysparm_delete_when_done=true&sysparm_is_remote=false&sysparm_ck=${s()}`,c=await o(a,{headers:{Accept:"application/xml"}});if(!c.ok)throw new Error(`Failed to download: ${c.status} ${c.statusText}`);const d=await c.blob(),l=window.URL.createObjectURL(d),u=document.createElement("a");u.href=l;const p=i(t),f=r?"-"+i(r):"";u.download=`${p}${f}.xml`,document.body.appendChild(u),u.click(),document.body.removeChild(u),window.URL.revokeObjectURL(l)}(p.staged_set,d,l,u),console.log(`[${n}/${t}] Success: ${l}`),!0}catch(s){return console.error(`[${n}/${t}] Error exporting ${e}:`,s),!1}}async function l(t,s,o,r){let a=0,i=0,c=s;const l=Object.keys(t).length;if(l>0){console.log(`\nExporting ${l} ${r}...`);for(const[s]of Object.entries(t)){c++,n(s,"processing");await d(s,c,o)?(a++,n(s,"completed")):(i++,n(s,"error")),e(c,o),c<o&&await new Promise((e=>setTimeout(e,500)))}}return{successCount:a,failCount:i,currentIndex:c}}try{if(!window.location.href.includes("sys_update_set"))return void alert("Please navigate to an Update Set list or record to use this bookmarklet.");console.log("Getting query from URL...");const n=function(){try{const e=decodeURIComponent(window.location.href),n=/[\?\&]sysparm_query=(.*?)(?:\&|$)/;let t=e.match(n)?.[1];if(t){try{t=decodeURIComponent(t)}catch(e){}return t}const s=/[\?\&](?:sysparm_sys_id|sys_id)=([a-f0-9]{32})/,o=e.match(s)?.[1];return o?`sys_id=${o}`:"active=true"}catch(e){return console.error("Error getting query from URL:",e),"active=true"}}();console.log(`Query: ${n}`),console.log("Fetching and categorizing update sets...");const{standaloneSets:s,includedBaseSets:i,inheritedBaseSets:c}=await async function(e){try{const n=await async function(e){const n=await o(`/api/now/table/sys_update_set?sysparm_query=${encodeURIComponent(e)}&sysparm_fields=sys_id,name,base_update_set`);return(await n.json()).result}(e),t=n.filter((e=>r(e)));let s=[];if(t.length>0){const e=t.map((e=>e.base_update_set.value)).join(",");s=await async function(e){const n=await o(`/api/now/table/sys_update_set?sysparm_query=sys_idIN${e}&sysparm_fields=sys_id,name,base_update_set`);return(await n.json()).result}(e)}const i={},c={},d={};return n.filter((e=>!r(e)||a({...e,sys_id:e.sys_id}))).forEach((e=>{i[e.sys_id]=e})),s.filter((e=>n.some((n=>n.sys_id===e.base_update_set?.value)))).forEach((e=>{c[e.sys_id]=e})),s.filter((e=>!c[e.sys_id])).forEach((e=>{d[e.sys_id]=e})),{standaloneSets:i,includedBaseSets:c,inheritedBaseSets:d}}catch(e){return console.error("Error categorizing update sets:",e),{standaloneSets:{},includedBaseSets:{},inheritedBaseSets:{}}}}(n),d=Object.keys(s).length,u=Object.keys(i).length,p=d+u+Object.keys(c).length;if(0===p)return void alert("No update sets found matching the current query.");const f=function(){const e=document.createElement("div");return e.id="eus-modal",e.innerHTML='\n            <style>\n                #eus-modal {\n                    position: fixed;\n                    top: 0;\n                    left: 0;\n                    right: 0;\n                    bottom: 0;\n                    background: rgba(0, 0, 0, 0.5);\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    z-index: 999999;\n                    font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif;\n                }\n                #eus-content {\n                    background: white;\n                    border-radius: 8px;\n                    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);\n                    max-width: 600px;\n                    width: 90%;\n                    max-height: 80vh;\n                    display: flex;\n                    flex-direction: column;\n                }\n                #eus-header {\n                    padding: 20px;\n                    border-bottom: 1px solid #e5e7eb;\n                    position: relative;\n                }\n                #eus-header h2 {\n                    margin: 0 0 8px 0;\n                    font-size: 18px;\n                    font-weight: 600;\n                    color: #111827;\n                    padding-right: 30px;\n                }\n                #eus-header p {\n                    margin: 0;\n                    font-size: 14px;\n                    color: #6b7280;\n                }\n                #eus-close {\n                    position: absolute;\n                    top: 20px;\n                    right: 20px;\n                    width: 24px;\n                    height: 24px;\n                    border: none;\n                    background: transparent;\n                    color: #6b7280;\n                    cursor: pointer;\n                    padding: 0;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    border-radius: 4px;\n                    transition: all 0.15s;\n                }\n                #eus-close:hover {\n                    background: #f3f4f6;\n                    color: #111827;\n                }\n                #eus-close svg {\n                    width: 20px;\n                    height: 20px;\n                }\n                #eus-body {\n                    padding: 20px;\n                    overflow-y: auto;\n                    flex: 1;\n                }\n                #eus-progress {\n                    margin-bottom: 16px;\n                    font-size: 14px;\n                    color: #6b7280;\n                }\n                .eus-section {\n                    margin-bottom: 20px;\n                }\n                .eus-section h3 {\n                    font-size: 14px;\n                    font-weight: 500;\n                    color: #111827;\n                    margin: 0 0 4px 0;\n                }\n                .eus-section-desc {\n                    font-size: 12px;\n                    color: #6b7280;\n                    margin: 0 0 12px 0;\n                }\n                .eus-item {\n                    display: flex;\n                    align-items: center;\n                    justify-content: space-between;\n                    padding: 12px;\n                    background: #f9fafb;\n                    border: 1px solid #e5e7eb;\n                    border-radius: 6px;\n                    margin-bottom: 6px;\n                    transition: background 0.15s;\n                }\n                .eus-item:hover {\n                    background: #f3f4f6;\n                }\n                .eus-item-name {\n                    font-size: 14px;\n                    color: #374151;\n                    font-weight: 500;\n                }\n                .eus-status {\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    width: 20px;\n                    height: 20px;\n                }\n                .eus-status svg {\n                    width: 16px;\n                    height: 16px;\n                }\n                .eus-pending { color: #9ca3af; }\n                .eus-processing { color: #3b82f6; animation: spin 1s linear infinite; }\n                .eus-completed { color: #10b981; }\n                .eus-error { color: #ef4444; }\n                @keyframes spin {\n                    from { transform: rotate(0deg); }\n                    to { transform: rotate(360deg); }\n                }\n                #eus-footer {\n                    padding: 16px 20px;\n                    border-top: 1px solid #e5e7eb;\n                    display: flex;\n                    justify-content: flex-end;\n                    gap: 12px;\n                }\n                .eus-btn {\n                    padding: 8px 16px;\n                    border-radius: 6px;\n                    font-size: 14px;\n                    font-weight: 500;\n                    cursor: pointer;\n                    border: 1px solid;\n                    transition: all 0.15s;\n                }\n                .eus-btn-primary {\n                    background: #3b82f6;\n                    color: white;\n                    border-color: #3b82f6;\n                }\n                .eus-btn-primary:hover:not(:disabled) {\n                    background: #2563eb;\n                    border-color: #2563eb;\n                }\n                .eus-btn-secondary {\n                    background: white;\n                    color: #374151;\n                    border-color: #d1d5db;\n                }\n                .eus-btn-secondary:hover:not(:disabled) {\n                    background: #f9fafb;\n                }\n                .eus-btn-danger {\n                    background: #ef4444;\n                    color: white;\n                    border-color: #ef4444;\n                }\n                .eus-btn-danger:hover:not(:disabled) {\n                    background: #dc2626;\n                    border-color: #dc2626;\n                }\n                .eus-btn:disabled {\n                    opacity: 0.5;\n                    cursor: not-allowed;\n                }\n            </style>\n            <div id="eus-content">\n                <div id="eus-header">\n                    <h2>Export Update Sets</h2>\n                    <p id="eus-query"></p>\n                    <button id="eus-close" title="Close (Esc)">\n                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path d="M6 18L18 6M6 6l12 12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                        </svg>\n                    </button>\n                </div>\n                <div id="eus-body">\n                    <div id="eus-progress"></div>\n                    <div id="eus-sections"></div>\n                </div>\n                <div id="eus-footer">\n                    <button class="eus-btn eus-btn-secondary" id="eus-cancel">Cancel</button>\n                    <button class="eus-btn eus-btn-primary" id="eus-start">Start Export</button>\n                </div>\n            </div>\n        ',document.body.appendChild(e),e}();!function(n,t,s,o){const r=document.getElementById("eus-query"),a=document.getElementById("eus-sections"),i=n.length>60?n.substring(0,60)+"...":n;r.textContent=`Query: ${i}`;const c=[{title:"Standalone Update Sets",desc:"Update sets not apart of a batch in the filter",sets:t},{title:"Batch Update Sets",desc:"Batch update sets with the base in the filter",sets:s},{title:"Inherited Batch Update Sets",desc:"Batch update with children in the filter",sets:o}];a.innerHTML="",e(0,Object.keys(t).length+Object.keys(s).length+Object.keys(o).length),c.forEach((e=>{if(0===Object.keys(e.sets).length)return;const n=document.createElement("div");n.className="eus-section",n.innerHTML=`\n                <h3>${e.title}</h3>\n                <p class="eus-section-desc">${e.desc}</p>\n            `,Object.entries(e.sets).forEach((([e,t])=>{const s=document.createElement("div");s.className="eus-item",s.id=`eus-item-${e}`,s.innerHTML=`\n                    <span class="eus-item-name">${t.name}</span>\n                    <span class="eus-status eus-pending">\n                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <circle cx="12" cy="12" r="10" stroke-width="2"/>\n                            <path d="M12 6v6l4 2" stroke-width="2" stroke-linecap="round"/>\n                        </svg>\n                    </span>\n                `,n.appendChild(s)})),a.appendChild(n)}))}(n,s,i,c);let g=!1;const m=async()=>{if(g)return;g=!0;const e=document.getElementById("eus-start"),n=document.getElementById("eus-cancel");e&&(e.disabled=!0,e.textContent="Exporting..."),n&&(n.textContent="Stop",n.className="eus-btn eus-btn-danger");try{console.log(`Starting export of ${p} update set(s)...`);let o=0,r=0,a=0;if(g){const e=await l(s,a,p,"standalone update set(s)");o+=e.successCount,r+=e.failCount,a=e.currentIndex}if(g){const e=await l(i,a,p,"batch update set(s) (base in filter)");o+=e.successCount,r+=e.failCount,a=e.currentIndex}if(g){const e=await l(c,a,p,"inherited batch(es) (children in filter)");o+=e.successCount,r+=e.failCount}console.log(`\nExport complete! Success: ${o}, Failed: ${r}`),e&&(e.textContent="Export Complete",e.disabled=!1),n&&(n.textContent="Close",n.className="eus-btn eus-btn-secondary",n.onclick=t)}catch(n){console.error("Export error:",n),e&&(e.textContent="Export Failed",e.disabled=!1)}finally{g=!1}},y=document.getElementById("eus-start"),h=document.getElementById("eus-cancel"),b=document.getElementById("eus-close");y&&(y.onclick=m),h&&(h.onclick=()=>{g?(g=!1,console.log("Export stopped by user")):t()}),b&&(b.onclick=()=>{g||t()}),window.eusKeyHandler=e=>{"Escape"!==e.key||g||t()},document.addEventListener("keydown",window.eusKeyHandler),f.onclick=e=>{e.target!==f||g||t()}}catch(e){console.error("Fatal error:",e),alert(`Export failed: ${e.message}\n\nCheck the console for details.`)}}();